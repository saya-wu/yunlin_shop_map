{% extends "base.html" %}

{% block content %}
<div class="audio-player">
    <div class="player-header">
        <a href="javascript:history.back()" class="back-button">
            <i class="fas fa-arrow-left"></i> 返回
        </a>
        <h1>{{ item.title }}</h1>
    </div>

    <div class="player-container">
        <!-- 音頻元素 -->
        <audio id="audio" preload="auto" controls>
            <source src="{{ url_for('static', filename='audio/' + item.audio) }}" type="audio/x-m4a">
            <source src="{{ url_for('static', filename='audio/' + item.audio) }}" type="audio/mp4">
            <source src="{{ url_for('static', filename='audio/' + item.audio) }}" type="audio/mpeg">
            您的瀏覽器不支持音頻播放
        </audio>

        <!-- 調試信息 -->
        <div id="debugInfo" class="debug-panel">
            <div class="debug-item">
                <span class="debug-label">音頻路徑:</span>
                <span id="audioPath">{{ url_for('static', filename='audio/' + item.audio) }}</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">音頻狀態:</span>
                <span id="audioStatus">未初始化</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">音頻格式:</span>
                <span id="audioFormat">未知</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">音頻時長:</span>
                <span id="audioDuration">未知</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">網絡狀態:</span>
                <span id="networkState">未知</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">就緒狀態:</span>
                <span id="readyState">未知</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">錯誤信息:</span>
                <span id="errorMessage">無</span>
            </div>
        </div>
    </div>
</div>

<style>
.audio-player {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.player-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.back-button {
    color: #666;
    text-decoration: none;
    margin-right: 15px;
}

.back-button:hover {
    color: #333;
}

.player-header h1 {
    margin: 0;
    font-size: 1.5em;
    color: #333;
}

.player-container {
    padding: 20px;
}

audio {
    width: 100%;
    margin-bottom: 20px;
}

.debug-panel {
    margin-top: 30px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 5px;
    font-size: 0.9em;
}

.debug-item {
    margin: 8px 0;
    display: flex;
    gap: 10px;
}

.debug-label {
    color: #666;
    font-weight: bold;
    min-width: 100px;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('audio');
    const audioStatus = document.getElementById('audioStatus');
    const audioFormat = document.getElementById('audioFormat');
    const audioDuration = document.getElementById('audioDuration');
    const networkState = document.getElementById('networkState');
    const readyState = document.getElementById('readyState');
    const errorMessage = document.getElementById('errorMessage');

    function updateStatus(status) {
        audioStatus.textContent = status;
        console.log('音頻狀態:', status);
    }

    function updateErrorMessage(message) {
        errorMessage.textContent = message;
        console.error('錯誤:', message);
    }

    function updateNetworkState() {
        const states = [
            '未初始化',
            '空閒',
            '正在加載',
            '無來源'
        ];
        networkState.textContent = states[audio.networkState];
    }

    function updateReadyState() {
        const states = [
            '無數據',
            '有元數據',
            '可播放當前幀',
            '可播放下一幀',
            '可播放足夠數據'
        ];
        readyState.textContent = states[audio.readyState];
    }

    // 音頻加載相關事件
    audio.addEventListener('loadstart', () => {
        updateStatus('開始加載音頻');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('progress', () => {
        updateStatus('正在加載數據');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('canplay', () => {
        updateStatus('可以開始播放');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('canplaythrough', () => {
        updateStatus('可以流暢播放');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('loadedmetadata', () => {
        updateStatus('元數據已加載');
        audioDuration.textContent = `${Math.round(audio.duration)}秒`;
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('loadeddata', () => {
        updateStatus('音頻數據已加載');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('waiting', () => {
        updateStatus('等待數據中...');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('playing', () => {
        updateStatus('正在播放');
        updateNetworkState();
        updateReadyState();
    });

    audio.addEventListener('pause', () => {
        updateStatus('已暫停');
        updateNetworkState();
        updateReadyState();
    });

    // 錯誤處理
    audio.addEventListener('error', function(e) {
        const error = audio.error;
        let errorMsg = '未知錯誤';
        
        if (error) {
            switch (error.code) {
                case 1:
                    errorMsg = '加載過程被中止';
                    break;
                case 2:
                    errorMsg = '網絡錯誤';
                    break;
                case 3:
                    errorMsg = '音頻解碼錯誤';
                    break;
                case 4:
                    errorMsg = '音頻格式不支持';
                    break;
            }
            errorMsg += ` (錯誤代碼: ${error.code})`;
        }
        
        updateErrorMessage(errorMsg);
        updateStatus('載入失敗');
        updateNetworkState();
        updateReadyState();
        
        // 輸出詳細的調試信息
        console.error('音頻錯誤詳情:', {
            errorCode: error ? error.code : 'unknown',
            errorMessage: error ? error.message : 'unknown',
            networkState: audio.networkState,
            readyState: audio.readyState,
            currentSrc: audio.currentSrc,
            audioFormat: audio.currentSrc ? audio.currentSrc.split('.').pop() : 'unknown'
        });
    });

    // 檢測實際使用的音頻格式
    const source = audio.querySelector('source[type="audio/x-m4a"]');
    if (source && source.src) {
        audioFormat.textContent = 'M4A';
    } else {
        audioFormat.textContent = 'MP3';
    }
});
</script>
{% endblock %}
